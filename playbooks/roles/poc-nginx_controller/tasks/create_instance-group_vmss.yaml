- name: Retrieve the NGINX Controller auth token
  include_role:
    name: nginxinc.nginx_controller_generate_token
  vars:
    nginx_controller_fqdn: "{{extra_nginx_controller_ip}}"
    nginx_controller_user_email: "{{extra_nginx_controller_username}}"
    nginx_controller_user_password: "{{extra_nginx_controller_password}}"

- name: Create location
  include_role:
    name: nginxinc.nginx_controller_location
  vars:
    nginx_controller_fqdn: "{{extra_nginx_controller_ip}}"
    nginx_controller_location:
      metadata:
        name: "{{ extra_location | lower }}"
        displayName: "{{ extra_location | lower }}"
        description: "Generated by CMP"
        tags:
          - "HUB"
      desiredState:
        type: OTHER_LOCATION

- name: Create instance group
  uri:
    url: "https://{{ extra_nginx_controller_ip }}/api/v1/infrastructure/instance-groups/{{ extra_vmss_name | lower }}"
    method: PUT
    headers:
      Content-Type: "application/json"
      Cookie: "{{ nginx_controller_auth_token }}"
    body:
      metadata:
        name: "{{ extra_vmss_name | lower }}"
        displayName: "{{ extra_vmss_name | lower }}"
        description: "Generated by CMP"
        tags:
          - "AppProtect"
      desiredState: {}
    body_format: json
    return_content: yes
    validate_certs: no
    status_code: 200, 201, 202